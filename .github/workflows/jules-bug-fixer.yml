# Jules Bug Fix Agent
#
# Automatically diagnoses and fixes bugs when issues are labeled with "bug".
# Only triggers for trusted users to prevent exploitation.

name: Jules - Auto-Fix Bugs

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: read

jobs:
  fix-bug:
    # Only run when the 'bug' label is added
    if: github.event.label.name == 'bug'
    runs-on: ubuntu-latest

    steps:
      - name: Invoke Jules
        # SECURITY: Only allow trusted users to trigger Jules
        # Add your GitHub username and trusted collaborators here
        if: ${{ contains(fromJSON('["alexc", "anchapin"]'), github.event.issue.user.login) }}
        uses: google-labs-code/jules-action@v1.0.0
        with:
          prompt: |
            Please diagnose and fix the following bug in LuminaGuard:

            ## Issue: ${{ github.event.issue.title }}
            ${{ github.event.issue.body }}

            **Issue URL:** ${{ github.event.issue.html_url }}

            **Debugging Process:**

            1. **Analysis** - Review the bug report and identify the root cause
            2. **Diagnosis** - Trace the issue through the codebase
               - Check both Rust (orchestrator/) and Python (agent/) code
               - Review related tests
               - Check error logs if provided
            3. **Fix** - Implement a minimal, targeted fix
               - Follow TDD: write failing test first, then fix
               - Run `make fmt` to format code
               - Run `make test` to verify all tests pass
            4. **Testing** - Add a regression test that would have caught this bug
            5. **Documentation** - Add comments explaining the fix

            **Project Context:**
            - LuminaGuard is a local-first Agentic AI runtime
            - Rust Orchestrator handles: CLI, VM spawning, MCP connections
            - Python Agent handles: reasoning loop, tool use
            - See CLAUDE.md for full architecture details

            **Constraints:**
            - All tests must pass: `make test`
            - Format with `make fmt` before committing
            - loop.py must stay under 4,000 lines
            - Coverage must not decrease
            - Create PR with format: "fix(#<issue-num>): <description>"

            Please provide:
            - Clear explanation of the root cause
            - The complete fix with all necessary changes
            - Test cases to prevent regression
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          starting_branch: 'main'
