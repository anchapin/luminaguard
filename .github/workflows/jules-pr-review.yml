# Jules PR Review Agent
#
# Automatically reviews pull requests and provides feedback on:
# - Code quality issues
# - Potential bugs
# - Security vulnerabilities
# - Adherence to project standards

name: Jules - PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Invoke Jules for PR review
        uses: google-labs-code/jules-action@v1.0.0
        with:
          prompt: |
            Please review this Pull Request for LuminaGuard and provide feedback.

            **PR Context:**
            - Title: ${{ github.event.pull_request.title }}
            - Branch: ${{ github.event.pull_request.head_ref }}
            - Base: ${{ github.event.pull_request.base_ref }}
            - URL: ${{ github.event.pull_request.html_url }}

            **Review Focus Areas:**

            1. **Code Quality:**
               - Check for adherence to CLAUDE.md guidelines
               - Verify "Agentic Engineering over Vibe Coding" principles
               - Look for unnecessary complexity or over-engineering
               - Check that changes are minimal and targeted

            2. **Rust Code (orchestrator/):**
               - Proper error handling with anyhow::Result
               - Memory safety considerations
               - Appropriate use of async/await
               - Documentation quality

            3. **Python Code (agent/):**
               - loop.py line count (must stay < 4,000 lines)
               - Type hints usage
               - Docstring coverage
               - PEP 8 compliance

            4. **Testing:**
               - Are tests included for new functionality?
               - Are tests using Hypothesis (Python) or Proptest (Rust) for property-based testing?
               - Do the tests cover edge cases?

            5. **Security:**
               - No hardcoded secrets or API keys
               - No shell injection vulnerabilities
               - Proper input validation
               - Approval cliff logic is respected

            6. **Documentation:**
               - Is CLAUDE.md updated if architecture changes?
               - Are code changes self-documenting (clear names, obvious logic)?

            **Project Constraints:**
            - Overall coverage must not decrease (see .coverage-baseline.json)
            - Pre-commit hooks must pass (formatting, linting, complexity)
            - All changes must link to a GitHub issue

            **Output Format:**
            Please provide your review as a comment on the PR with:
            - Summary of changes
            - Potential issues (marked as ðŸ”´ Critical, ðŸŸ¡ Warning, ðŸ’¡ Suggestion)
            - Specific line references using GitHub markdown syntax
            - Approval decision or request for changes

            **Important:**
            - Be constructive and educational
            - Explain why something is problematic, not just that it is
            - Suggest specific improvements when possible
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          starting_branch: ${{ github.event.pull_request.head_ref }}
          include_last_commit: true
          include_commit_log: true
