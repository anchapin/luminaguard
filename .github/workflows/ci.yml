name: IronClaw CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Rust tests
  test-rust:
    name: Test Rust (Orchestrator)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v5
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v5
        with:
          path: orchestrator/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run cargo test
        working-directory: orchestrator
        run: cargo test --verbose

      - name: Run cargo clippy
        working-directory: orchestrator
        run: cargo clippy -- -D warnings

      - name: Check formatting
        working-directory: orchestrator
        run: cargo fmt --all -- --check

  # Python tests
  test-python:
    name: Test Python (Agent)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip packages
        uses: actions/cache@v5
        with:
          path: agent/.venv
          key: ${{ runner.os }}-pip-${{ matrix.python }}-${{ hashFiles('agent/pyproject.toml') }}

      - name: Install dependencies
        working-directory: agent
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install pytest hypothesis black mypy pylint

      - name: Run pytest
        working-directory: agent
        run: .venv/bin/pytest tests/ -v

      - name: Check formatting (black)
        working-directory: agent
        run: .venv/bin/black --check loop.py tests/

      - name: Run mypy
        working-directory: agent
        run: .venv/bin/mypy loop.py || true  # Optional during development

      - name: Check Python LOC limit
        working-directory: agent
        run: |
          LINES=$(wc -l < loop.py)
          echo "loop.py has $LINES lines"
          if [ $LINES -gt 4000 ]; then
            echo "❌ ERROR: loop.py exceeds 4,000 line limit"
            exit 1
          fi
          echo "✅ loop.py under 4,000 lines"

  # Integration tests (both languages)
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-rust, test-python]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd agent && python -m venv .venv && .venv/bin/pip install pytest hypothesis

      - name: Run all tests
        run: |
          echo "Running Rust tests..."
          cd orchestrator && cargo test --quiet
          echo "Running Python tests..."
          cd ../agent && .venv/bin/pytest tests/ -q
          echo "✅ All tests passed!"

  # Security checks
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Rust security audit
        working-directory: orchestrator
        run: cargo install cargo-audit && cargo audit || true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
