name: Quality Gates

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-bypass:
    name: Check Bypass Label
    runs-on: ubuntu-latest
    outputs:
      should-bypass: ${{ steps.check-label.outputs.should-bypass }}
    steps:
      - name: Check for bypass label
        id: check-label
        run: |
          if ${{ contains(github.event.pull_request.labels.*.name, 'quality: bypass') }}; then
            echo "‚ö†Ô∏è  Quality bypass requested via label"
            echo "should-bypass=true" >> $GITHUB_OUTPUT
          else
            echo "should-bypass=false" >> $GITHUB_OUTPUT
          fi
        if: github.event_name == 'pull_request'
      - name: No bypass for pushes
        run: echo "should-bypass=false" >> $GITHUB_OUTPUT
        if: github.event_name != 'pull_request'

  complexity:
    name: Complexity Analysis
    runs-on: ubuntu-latest
    needs: check-bypass
    if: needs.check-bypass.outputs.should-bypass != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install radon
        run: pip install radon

      - name: Python complexity analysis
        run: |
          cd agent
          radon cc . -a -nb
          echo "‚úÖ Complexity analysis passed"

      - name: Check complexity threshold
        run: |
          cd agent
          echo "Checking for blocks with complexity > 15..."
          if radon cc . -a -nb | grep -E "\d+ blocks \([^)]*\)" | awk -F'[()]' '{print $2}' | grep -E "C|D|F"; then
            echo "‚ùå Found blocks with complexity > 15"
            radon cc . -a -nb
            exit 1
          fi
          echo "‚úÖ No blocks exceed complexity threshold"

  documentation:
    name: Documentation Coverage
    runs-on: ubuntu-latest
    needs: check-bypass
    if: needs.check-bypass.outputs.should-bypass != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install interrogate
        run: pip install interrogate

      - name: Check documentation coverage
        run: |
          cd agent
          interrogate . --fail-under=60 -vv
          echo "‚úÖ Documentation coverage check passed"

  dead-code:
    name: Dead Code Detection
    runs-on: ubuntu-latest
    needs: check-bypass
    if: needs.check-bypass.outputs.should-bypass != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install pycln
        run: pip install pycln

      - name: Check for dead code
        run: |
          cd agent
          pycln . --check
          echo "‚úÖ Dead code check passed"

  duplication:
    name: Duplicate Code Detection
    runs-on: ubuntu-latest
    needs: check-bypass
    if: needs.check-bypass.outputs.should-bypass != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install jscpd
        run: npm install -g jscpd

      - name: Install jq for JSON parsing
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Check duplication threshold
        run: |
          set -euo pipefail

          # Remove any previous report
          rm -f jscpd-report.json

          # Generate JSON report to a file
          jscpd agent/ \
            -i "**/.venv/**" \
            -i "**/node_modules/**" \
            -i "**/.git/**" \
            -i "**/site-packages/**" \
            -i "**/__pycache__/**" \
            --min-lines 10 \
            --reporters json \
            --output .

          # Verify the report file was created
          if [ ! -f jscpd-report.json ]; then
            echo "‚ùå Expected jscpd-report.json was not created"
            echo "Directory contents:"
            ls -la
            exit 1
          fi

          # Parse the JSON report file
          CLONES=$(jq -r '.report.total.clones // 0' jscpd-report.json)

          echo "üîç Duplicate code blocks found: $CLONES"

          if [ "$CLONES" -eq 0 ]; then
            echo "‚úÖ No duplicate code found"
          elif [ "$CLONES" -gt 5 ]; then
            echo "‚ùå Too many duplicate code blocks ($CLONES > 5)"
            exit 1
          else
            echo "‚úÖ Duplicate count acceptable ($CLONES ‚â§ 5)"
          fi

  bloat:
    name: Bloat Detection
    runs-on: ubuntu-latest
    needs: check-bypass
    if: needs.check-bypass.outputs.should-bypass != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for large Python files
        run: |
          echo "Checking for Python files >100KB..."
          if find agent/ -name "*.py" -path "*/.venv/*" -prune -o -name "*.py" -size +100k -print | grep -q .; then
            echo "‚ùå Found large Python files:"
            find agent/ -name "*.py" -path "*/.venv/*" -prune -o -name "*.py" -size +100k -print
            exit 1
          fi
          echo "‚úÖ No bloated Python files found"

      - name: Check loop.py line count
        run: |
          if [ -f "agent/loop.py" ]; then
            LINES=$(wc -l < agent/loop.py)
            echo "loop.py: $LINES lines"
            if [ "$LINES" -gt 4000 ]; then
              echo "‚ùå loop.py exceeds 4,000 lines (current: $LINES)"
              exit 1
            fi
            echo "‚úÖ loop.py within limit ($LINES ‚â§ 4000)"
          else
            echo "‚ÑπÔ∏è  loop.py not created yet"
          fi

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [check-bypass, complexity, documentation, dead-code, duplication, bloat]
    if: always()
    steps:
      - name: Check bypass status
        run: |
          if [ "${{ needs.check-bypass.outputs.should-bypass }}" = "true" ]; then
            echo "# ‚ö†Ô∏è  Quality Gates Bypassed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Quality checks were bypassed via the **'quality: bypass'** label." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**This PR has been merged without quality gate enforcement.**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
      - name: Generate summary
        if: needs.check-bypass.outputs.should-bypass != 'true'
        run: |
          echo "# Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Complexity | ${{ needs.complexity.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.documentation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dead Code | ${{ needs.dead-code.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duplication | ${{ needs.duplication.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bloat | ${{ needs.bloat.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.complexity.result }}" != "success" ] || \
             [ "${{ needs.documentation.result }}" != "success" ] || \
             [ "${{ needs.dead-code.result }}" != "success" ] || \
             [ "${{ needs.duplication.result }}" != "success" ] || \
             [ "${{ needs.bloat.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ùå Quality Gates Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more quality checks failed. Please review and fix before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ All Quality Gates Passed" >> $GITHUB_STEP_SUMMARY
