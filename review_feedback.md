## Review of IronClaw PR 77

### Summary of Changes
- **Rust (Orchestrator)**:
  - **Fixed critical bug** in `vsock.rs` by implementing proper message framing (`read_u32`/`read_exact`) instead of recreating `BufReader`.
  - **Fixed critical bug** in `seccomp.rs` by using bounded `VecDeque` for audit logs.
  - Added new `FirewallManager` for network isolation (partially implemented).
  - Updated tests and documentation.
- **Python (Agent)**:
  - Added `agent/mcp_client.py` for MCP communication.
  - Added `agent/loop.py` placeholder logic.

### Potential Issues

#### ðŸ”´ Critical Issues

1.  **Python: Crash in `agent/mcp_client.py`**
    -   **File**: `agent/mcp_client.py` (line 165 approx, inside `_send_request`)
    -   **Issue**: The `McpClient` subprocess is initialized with `text=True` (universal_newlines), but `_send_request` attempts to write bytes using `.encode()`. This causes a `TypeError` and crashes the agent immediately.
    -   **Fix**: Remove `.encode()` when writing to `self._process.stdin` since it expects a string.

2.  **Rust: Seccomp Filter Ignored in Firecracker**
    -   **File**: `orchestrator/src/vm/firecracker.rs` (approx line 200, inside `configure_vm`)
    -   **Issue**: Although `VmConfig` includes a `seccomp_filter`, the `configure_vm` function never sends this configuration to the Firecracker API. This means the VM runs **without syscall filtering**, completely bypassing the security controls implemented in `seccomp.rs`.
    -   **Fix**: Add a call to `PUT /machine-config` or `/seccomp` (depending on API version) with the seccomp JSON generated by `filter.to_firecracker_json()`.

#### ðŸŸ¡ Warnings

3.  **Rust: Blocking I/O in Async Context**
    -   **File**: `orchestrator/src/vm/firewall.rs` (line 72 approx, `create_chain`, `add_drop_rules`)
    -   **Issue**: `FirewallManager` uses `std::process::Command` which blocks the thread. Since `spawn_vm` is `async`, this blocks the executor, potentially causing latency spikes or deadlocks under load.
    -   **Fix**: Use `tokio::process::Command` instead.

4.  **Rust: Fail-Open Firewall Configuration**
    -   **File**: `orchestrator/src/vm/mod.rs` (line 136 approx)
    -   **Issue**: `spawn_vm_with_config` logs a warning if firewall configuration fails (e.g., due to missing root) but proceeds to spawn the VM. While `VmConfig` disables networking by default, this bypasses the defense-in-depth layer.
    -   **Suggestion**: Consider making firewall failure fatal in production environments or when `enable_networking` is explicitly false.

5.  **Python: Unsafe Subprocess Access**
    -   **File**: `agent/mcp_client.py` (line 165 approx)
    -   **Issue**: `self._process` is initialized to `None`. If `_send_request` is called before `spawn` (or if spawn fails), it raises an `AttributeError` crash instead of a clean `McpError`.
    -   **Fix**: Add explicit `if self._process is None` checks.

#### ðŸ’¡ Suggestions

6.  **Python Type Hints**:
    -   `agent/loop.py` (line 80): `mcp_client` parameter is missing type hint (`McpClient`).
    -   `agent/mcp_client.py` (line 270): `__exit__` is missing type hints for exception arguments.

7.  **Rust JSON Generation**:
    -   `orchestrator/src/vm/config.rs` (line 65): `to_firecracker_json` uses `format!` string interpolation. It's safer and cleaner to use `serde_json` structures (like the ones defined in `firecracker.rs`) to generate JSON.

### Approval Decision
**Request Changes**. The Python crash and missing seccomp enforcement are critical blockers.
